#!/usr/bin/bash

die()
{
	echo $* >&2
	exit 1
}

if [[ ! -f $1 || ! -r $1 ]]; then
	die "cannot access input file ‘$1’"
fi

iputs()
{
	if [[ $1 -gt 0 ]]; then
		printf '\t%.0s' $(seq 1 $1)
	fi
	printf '%s' "$2"

	if [[ ! $3 ]]; then
		echo
	fi
}

get_num()
{
	echo $* | wc -w
}

get_seconds()
{
	echo $* | awk -F: '{ print ($1 * 3600) + ($2 * 60) + $3 }'
}

parse_schedule()
{
	parsing=
	fnum=0
	unum=0
	while read; do
		case "$REPLY" in
		'')
			if [[ $parsing ]]; then
				iputs 0       ' },'
				iputs 4       ".unum  = $unum,"
				iputs 3     '},'
				iputs 2   '},'
				iputs 2   ".fnum  = $fnum,"
				iputs 1 '},'

				parsing=
				fnum=0
			fi
			;&
		'#'*)
			continue
			;;
		$'\t'*)
			read -a data <<< "$REPLY"
			(( unum += $(get_num ${data[@]}) ))

			local last=${data[-1]}
			unset data[-1]

			printf ' 0x%s,' ${data[@]}
			printf ' 0x%s' $last
			;;
		*)
			read time data <<< "$REPLY"
			cnum=$(get_num $data)

			if [[ ! $parsing ]]; then
				parsing=1

				iputs 1 '{'
				iputs 2   ".start = $(get_seconds $time),"
				iputs 2   '.frame = (struct frame_info[]){'
				iputs 3     '{'
				iputs 4       '.delay = 0,'
			else
				iputs 0       ' },'
				iputs 4       ".unum  = $unum,"
				iputs 3     '},'
				iputs 3     '{'
				iputs 4       ".delay = $time,"
			fi

			read -a data <<< "$data"

				iputs 4       ".cnum  = $cnum,"
				iputs 4       ".data  = (uint8_t[]){" -n
				printf        ' 0x%s,' ${data[@]}

			(( fnum++ ))
			unum=0
			;;
		esac
	done < <(cat $1; echo)
}

echo '/* Automatically generated by schedule-signal <barroit> */

#ifdef SIGNAL_SCHEDULE_AUTOGEN_H
#error "The signal schedule should be included only once"
#endif

#define SIGNAL_SCHEDULE_AUTOGEN_H

struct frame_info {
	uint8_t *data;
	size_t cnum;
	size_t unum;
	uint8_t delay;
};

struct signal_schedule {
	uint64_t start;
	struct frame_info *frame;
	size_t fnum;
};

/**
 * In this case, using 'typedef' is appropriate since we don’t access the
 * fields in the 'end-user API'; we simply use these structs as a type.
 */
typedef struct frame_info frame_info_t;
typedef struct signal_schedule signal_schedule_t;
'

echo 'static const struct signal_schedule schedules[] = {'

parse_schedule $1

echo '};'
